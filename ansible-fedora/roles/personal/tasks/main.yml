# Install Tailscale VPN
- name: Check if Tailscale is installed
  stat:
    path: /usr/bin/tailscale
  register: tailscale_stat

- name: Install Tailscale
  block:
  - name: Download Tailscale installation script
    get_url:
      url: https://tailscale.com/install.sh
      dest: /tmp/tailscale-install.sh
      mode: '0755'

  - name: Run Tailscale installation script
    shell: sh /tmp/tailscale-install.sh
    args:
      creates: /usr/bin/tailscale

  - name: Clean up Tailscale installation script
    file:
      path: /tmp/tailscale-install.sh
      state: absent
  when: not tailscale_stat.stat.exists

- name: Enable Tailscale service
  systemd:
    name: tailscaled
    enabled: yes
    state: started

# Install Tailscale zsh completion in OMZ custom plugins
- name: Ensure Tailscale plugin directory exists
  file:
    path: "{{ user_home }}/.oh-my-zsh/custom/plugins/tailscale"
    state: directory
    mode: '0755'
  become: no

- name: Install Tailscale zsh completion
  shell: tailscale completion zsh > "{{ user_home }}/.oh-my-zsh/custom/plugins/tailscale/_tailscale"
  args:
    creates: "{{ user_home }}/.oh-my-zsh/custom/plugins/tailscale/_tailscale"
  when: tailscale_stat.stat.exists
  become: no
  environment:
    HOME: "{{ user_home }}"

# Install Visual Studio Code
- name: Check if VS Code is installed
  stat:
    path: /usr/bin/code
  register: vscode_stat

- name: Install Visual Studio Code
  block:
  - name: Import Microsoft GPG key
    rpm_key:
      key: https://packages.microsoft.com/keys/microsoft.asc
      state: present

  - name: Add Visual Studio Code repository
    yum_repository:
      name: vscode
      description: Visual Studio Code
      baseurl: https://packages.microsoft.com/yumrepos/vscode
      enabled: yes
      gpgcheck: yes
      gpgkey: https://packages.microsoft.com/keys/microsoft.asc

  - name: Install VS Code
    dnf:
      name: code
      state: present
  when: not vscode_stat.stat.exists
