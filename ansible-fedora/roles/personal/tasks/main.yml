# Install Dropbox headless daemon
- name: Check if Dropbox daemon is installed
  stat:
    path: "{{ user_home }}/.dropbox-dist/dropboxd"
  register: dropbox_daemon

- name: Check if Dropbox CLI is installed
  stat:
    path: /usr/local/bin/dropbox
  register: dropbox_cli

- name: Download and install Dropbox daemon
  block:
  - name: Download Dropbox tarball
    get_url:
      url: https://www.dropbox.com/download?plat=lnx.x86_64
      dest: /tmp/dropbox.tar.gz
      mode: '0644'
    become: no

  - name: Extract Dropbox to home directory
    unarchive:
      src: /tmp/dropbox.tar.gz
      dest: "{{ user_home }}"
      remote_src: yes
    become: no

  - name: Clean up Dropbox tarball
    file:
      path: /tmp/dropbox.tar.gz
      state: absent
  when: not dropbox_daemon.stat.exists

- name: Download Dropbox CLI Python script
  get_url:
    url: https://www.dropbox.com/download?dl=packages/dropbox.py
    dest: /usr/local/bin/dropbox
    mode: '0755'
  when: not dropbox_cli.stat.exists

# Install Tailscale VPN
- name: Check if Tailscale is installed
  stat:
    path: /usr/bin/tailscale
  register: tailscale_stat

- name: Install Tailscale
  block:
  - name: Download Tailscale installation script
    get_url:
      url: https://tailscale.com/install.sh
      dest: /tmp/tailscale-install.sh
      mode: '0755'

  - name: Run Tailscale installation script
    shell: sh /tmp/tailscale-install.sh
    args:
      creates: /usr/bin/tailscale

  - name: Clean up Tailscale installation script
    file:
      path: /tmp/tailscale-install.sh
      state: absent
  when: not tailscale_stat.stat.exists

- name: Enable Tailscale service
  systemd:
    name: tailscaled
    enabled: yes
    state: started
