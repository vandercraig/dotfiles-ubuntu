# Update system packages
- name: Update dnf cache
  dnf:
    update_cache: yes

- name: Upgrade all packages
  dnf:
    name: "*"
    state: latest

# Install base system packages
- name: Install base packages
  dnf:
    name:
    - git
    - git-lfs
    - curl
    - wget
    - "@development-tools"
    - ca-certificates
    - gnupg
    - zsh
    - tree
    - htop
    - jq
    - sqlite
    - unzip
    - zip
    - ripgrep
    - fd-find
    - bat
    - python3-pip
    - stow
    - gh
    - pass
    - direnv
    state: present

# Install Nushell from Gemfury repository
- name: Check if Nushell is installed
  stat:
    path: /usr/bin/nu
  register: nushell_stat

- name: Add Nushell Gemfury repository
  copy:
    content: |
      [gemfury-nushell]
      name=Gemfury Nushell Repo
      baseurl=https://yum.fury.io/nushell/
      enabled=1
      gpgcheck=0
      gpgkey=https://yum.fury.io/nushell/gpg.key
    dest: /etc/yum.repos.d/fury-nushell.repo
    mode: '0644'
  when: not nushell_stat.stat.exists

- name: Install Nushell
  dnf:
    name: nushell
    state: present
  when: not nushell_stat.stat.exists

# Install Neovim (version 0.11+ required for NvChad)
- name: Check if Neovim is installed
  stat:
    path: /usr/local/bin/nvim
  register: nvim_stat

- name: Check Neovim version if installed
  shell: nvim --version 2>/dev/null | head -n1 | grep -oP 'v\K[0-9]+\.[0-9]+' || echo "0.0"
  register: nvim_version_check
  changed_when: false
  when: nvim_stat.stat.exists

- name: Set Neovim version fact
  set_fact:
    nvim_version: "{{ nvim_version_check.stdout if nvim_stat.stat.exists else '0.0' }}"

- name: Determine if Neovim needs installation
  set_fact:
    needs_nvim_install: "{{ not nvim_stat.stat.exists or nvim_version is version('0.11', '<') }}"

- name: Install Neovim from AppImage
  block:
  - name: Download Neovim stable AppImage (v0.11.4+)
    get_url:
      url: https://github.com/neovim/neovim/releases/download/stable/nvim-linux-x86_64.appimage
      dest: /tmp/nvim.appimage
      mode: '0755'

  - name: Install Neovim AppImage to /usr/local/bin
    copy:
      src: /tmp/nvim.appimage
      dest: /usr/local/bin/nvim
      mode: '0755'
      remote_src: yes

  - name: Clean up AppImage download
    file:
      path: /tmp/nvim.appimage
      state: absent
  when: needs_nvim_install

# Install WezTerm (skip on WSL)
- name: Check if running on WSL
  shell: grep -qi microsoft /proc/version
  register: is_wsl
  failed_when: false
  changed_when: false

- name: Check if WezTerm is installed
  stat:
    path: /usr/bin/wezterm
  register: wezterm_stat
  when: is_wsl.rc != 0

- name: Install WezTerm from Copr
  block:
  - name: Install dnf plugins (required for copr)
    dnf:
      name: dnf-plugins-core
      state: present

  - name: Enable WezTerm Copr repository
    community.general.copr:
      name: wezfurlong/wezterm-nightly
      state: enabled

  - name: Install WezTerm
    dnf:
      name: wezterm
      state: present
  when: is_wsl.rc != 0 and not wezterm_stat.stat.exists

# Install Starship prompt
- name: Check if Starship is installed
  stat:
    path: /usr/local/bin/starship
  register: starship_stat

- name: Install Starship
  shell: curl -sS https://starship.rs/install.sh | sh -s -- --yes
  when: not starship_stat.stat.exists

# Install Starship zsh completion in OMZ custom plugins
- name: Ensure Starship plugin directory exists
  file:
    path: "{{ user_home }}/.oh-my-zsh/custom/plugins/starship"
    state: directory
    mode: '0755'
  become: no

- name: Install Starship zsh completion
  shell: starship completions zsh > "{{ user_home }}/.oh-my-zsh/custom/plugins/starship/_starship"
  args:
    creates: "{{ user_home }}/.oh-my-zsh/custom/plugins/starship/_starship"
  when: starship_stat.stat.exists
  become: no
  environment:
    HOME: "{{ user_home }}"

# Install uv (Python package manager)
- name: Check if uv is installed
  stat:
    path: "{{ user_home }}/.local/bin/uv"
  register: uv_stat
  become: no

- name: Install uv
  shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  when: not uv_stat.stat.exists
  become: no
  environment:
    HOME: "{{ user_home }}"

# Install Python 3.12 via uv
- name: Install Python 3.12 via uv
  shell: "{{ user_home }}/.local/bin/uv python install 3.12"
  become: no
  environment:
    HOME: "{{ user_home }}"
  when: not uv_stat.stat.exists

# Install Node.js and npm
- name: Check if Node.js is installed
  stat:
    path: /usr/bin/node
  register: node_stat

- name: Download and install NodeSource setup script for Fedora
  shell: |
    curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo -E bash -
  when: not node_stat.stat.exists

- name: Install Node.js
  dnf:
    name: nodejs
    state: present
  when: not node_stat.stat.exists

# Install Docker
- name: Check if Docker is installed
  stat:
    path: /usr/bin/docker
  register: docker_stat

- name: Install Docker on Fedora
  block:
  - name: Add Docker repository
    get_url:
      url: https://download.docker.com/linux/fedora/docker-ce.repo
      dest: /etc/yum.repos.d/docker-ce.repo

  - name: Install Docker
    dnf:
      name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
      state: present

  - name: Start and enable Docker service
    systemd:
      name: docker
      state: started
      enabled: yes

  - name: Add user to docker group
    user:
      name: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
      groups: docker
      append: yes
  when: not docker_stat.stat.exists

# Install Python tools via uv
- name: Install Python development tools via uv
  shell: "{{ user_home }}/.local/bin/uv tool install {{ item }}"
  loop:
  - ruff
  - pyright
  - bandit
  - pre-commit
  - datasette
  - litecli
  - csvkit
  - rich-cli
  - just
  become: no
  environment:
    HOME: "{{ user_home }}"
  ignore_errors: yes

# Setup directories
- name: Ensure ~/.local/bin exists
  file:
    path: "{{ user_home }}/.local/bin"
    state: directory
    mode: '0755'
  become: no

- name: Ensure ~/bin exists
  file:
    path: "{{ user_home }}/bin"
    state: directory
    mode: '0755'
  become: no

- name: Ensure ~/.config directory exists
  file:
    path: "{{ user_home }}/.config"
    state: directory
    mode: '0755'
  become: no

# Install Oh My Zsh (idempotent)
- name: Check if Oh My Zsh is installed
  stat:
    path: "{{ user_home }}/.oh-my-zsh"
  register: omz_stat
  become: no

- name: Install Oh My Zsh using the official installer
  shell: sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
  args:
    creates: "{{ user_home }}/.oh-my-zsh"
    chdir: "{{ user_home }}"
  when: not omz_stat.stat.exists
  become: no
  environment:
    HOME: "{{ user_home }}"
    RUNZSH: "no"
    CHSH: "no"

# Install Oh My Zsh plugins (zsh-autosuggestions, zsh-syntax-highlighting)
- name: Ensure Oh My Zsh custom plugins directory exists
  file:
    path: "{{ user_home }}/.oh-my-zsh/custom/plugins"
    state: directory
    mode: '0755'
  become: no

- name: Install zsh-autosuggestions plugin
  git:
    repo: https://github.com/zsh-users/zsh-autosuggestions.git
    dest: "{{ user_home }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
    update: no
  when: omz_stat.stat.exists or (omz_stat is defined and not omz_stat.stat.exists == false)
  become: no
  environment:
    HOME: "{{ user_home }}"

- name: Install zsh-syntax-highlighting plugin
  git:
    repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
    dest: "{{ user_home }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
    update: no
  when: omz_stat.stat.exists or (omz_stat is defined and not omz_stat.stat.exists == false)
  become: no
  environment:
    HOME: "{{ user_home }}"

# Note: Fedora packages bat and fd with correct names, no symlinks needed!

# Set zsh as default shell
- name: Set zsh as default shell
  user:
    name: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
    shell: /usr/bin/zsh
